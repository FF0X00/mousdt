<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<!-- import CSS -->
	<link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
	<link href="bootstrap.min.css" rel="stylesheet">

</head>

<body>
	<div id="app">
		<div class="container-sm text-center" style="max-width: 600px; ">
			<h1>收银台</h1>
			<el-card class="box-card" v-loading="isLoading">
				<div style="text-align: center;"><strong style="font-size: 2rem;">{{ order_price }} {{ currency }}</strong>
				</div>

				<img style="width: 100%" :src="'/static/QR_code/' + wallet_address + '.png'" />

				<div style="margin-top: 15px;" @click="copyWalletAddress" class="clipboard" data-clipboard-target="#wallet_address">
				  <el-input id="wallet_address" :value="wallet_address" class="input-with-select" readonly>
					<el-button slot="append" icon="el-icon-copy-document">复制</el-button>
				  </el-input>
				</div>



				<div style="text-align: center;"><strong style="font-size: 2rem;">已付 {{ paid_price }} / {{ order_price
						}}</strong></div>
				<div style="text-align: center;"><strong style="font-size: 2rem;">剩余时间 {{ remain_time | parseTime }}</strong>
				</div>
				
				<span>请在约定时间内使用<strong>{{ contract_type }}</strong>主网给地址<strong>{{ wallet_address }}</strong>转账<strong>{{ order_price }} {{ currency }}</strong></span>
				<br /><br />
				
				<span>转账请求需要1-3分钟时间广播，请在确定支付时预留足够的确认时间，若订单结束后仍然没有到账，请联系网站管理员</span>
				
			</el-card>
			
		</div>
		
		<el-dialog
		  :visible.sync="dialogVisible"
		  width="30%">
		  <span>订单超时</span>
		  <span slot="footer" class="dialog-footer">
			<el-button @click="dialogVisible = false">取 消</el-button>
			<el-button type="primary" @click="dialogVisible = false">确 定</el-button>
		  </span>
		</el-dialog>
		
	</div>
</body>
<script src="vue.js"></script>
<script src="vue-router.js"></script>
<script src="element-ui.js"></script>
<script src="en.js"></script>
<script src="axios.min.js"></script>
<script src="clipboard.min.js"></script>

<script>
	new ClipboardJS('.clipboard');

	var router = new VueRouter({
		mode: 'history',
		routes: []
	});

	new Vue({
		router,
		el: '#app',
		data: function () {
			return {
				currency: 'USDT',
				dialogVisible: false,
				contract_type: undefined,
				order_price: undefined,
				wallet_address: undefined,
				paid_price: 0,
				remain_time: 0,
				token: this.$route.query.token,
				timer: null,
				order_check_interval: 5,
				isLoading: false,
			}
		},
		created() {
			this.isLoading = true;
			this.check_order();
			this.timer = setInterval(() => {
				if (this.remain_time % this.order_check_interval == 0) {
					this.check_order();
				}
				this.remain_time = this.remain_time - 1;

			}, 1000);
		},
		methods: {
			check_order() {
				axios({
					method: 'post',
					url: '/api/pay/check_order',
					data: {
						token: this.token,
					}
				}).then((response) => {
					let status = response.data.data.status;
					if (status == 1) {
						let return_url = response.data.data.return_url;
						window.location.href = return_url;
					}
					if (status == -1) {
						clearInterval(this.timer);
						let message = response.data.msg;
						this.$message(message);
						this.dialogVisible = true;
						this.isLoading = true;
					}

					let transfer_items = response.data.data.transfer_items;
					this.paid_price = response.data.data.transfer_items.map(x => x.price).reduce((a, b) => a + b, 0);
					this.wallet_address = response.data.data.wallet_address;
					this.contract_type = response.data.data.contract_type;
					this.order_price = response.data.data.order_price;
					this.remain_time = response.data.data.remain_time;

					this.isLoading = false;
				}).catch((error) => {
				
					// clearInterval(this.timer);
					
				})
			},

       copyWalletAddress(data) {
			console.log(data)
			this.$message('复制成功');
		 }
		},
		filters: {
			parseTime(input_seconds) {

				minutes = new Date(input_seconds * 1000).toISOString().substring(14, 16)
				seconds = new Date(input_seconds * 1000).toISOString().substring(17, 19)
				return minutes + ':' + seconds
			}
		}

	})
</script>

</html>